<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Statistical Computing</title>

    <meta name="author" content="Xi (Rossi) LUO">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="reveal.js.4.1.3/dist/reset.css">
    <link rel="stylesheet" href="reveal.js.4.1.3/dist/reveal.css">
    <!-- <link rel="stylesheet" href="reveal.js.4.1.3/dist/theme/white.css" id="theme"> -->



    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="reveal.js.4.1.3/plugin/highlight/github-dark-dimmed.min.css">
    <!--
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/default.min.css">
-->
    <link rel="stylesheet" href="./css/rossisimple.css" id="theme">
    <!--    <link rel="stylesheet" href="./css/brightRoom.css" id="theme">-->
</head>

<body>

    <div class="reveal">

        <!-- Any section element inside of this container is displayed as a slide -->
        <div class="slides">

            <!--      place holder for credits: empty for now -->
            <credit></credit>
            <!-- <style>
                .rds_db credit:after {
                    content: "https://r4ds.had.co.nz/relational-data.html";
                }
            </style> -->
            <section>
                <h1><strong>
                        <highlight>Statistical</highlight>
                        <emph>Computing</emph>
                    </strong></h1>
                <br>
                <h2>Profiling</h2>
                <br>

                <h3>Xi (Rossi) <strong>LUO</strong></h3>
                <br>
                <p><small>Department of Biostatistics and Data Science<br>
                        School of Public Health<br>The University of Texas Health Science Center at Houston</small></p>
            </section>


            <section>
                <h2>Memory and Speed</h2>
                <ul>
                    <li>Common theme: large mem, fast exec; low mem, slow exec
                    </li>
                    <li>All R objects stored in memory</li>
                    <li>Best practice: balance time and space trade-off
                    </li>
                </ul>
            </section>

            <section>
                <h2>Improve Speed</h2>
                <ul>
                    <li>Optimize R code through vectorization</li>
                    <li>Write CPU intensive parts in a compiled language, e.g. C/C++/Fortran</li>
                    <li>Using parallel R</li>
                </ul>
            </section>

            <section>
                <h2>For Loop: Misconception</h2>
                <ul>
                    <li>
                        <emphcode>for</emphcode> is not necessarily slow
                    </li>
                    <li>Wrong to claim <emphcode>apply</emphcode> is faster, also implemented in R</li>
                    <li>No need to avoid for-loops at all costs</li>
                    <li>Vectorization may help improve speed</li>
                    <li>Pre-allocation and avoid c/cbind</li>
                    <li>Avoid copy-on-modify</li>
                </ul>
            </section>


            <section>
                <h2>For Loop</h2>
                <pre><code data-trim data-noescape class="language-r">
                    f_for &lt;- function(k) {
                        re &lt;- rep(0, k)
                        for (i in 1:k) {
                           re[i] &lt;- i^1.5
                        }
                        return(re)
                     }                     
                     f_apply &lt;- function(k) {
                        return(sapply(1:k, function(i) i^1.5))
                     }
                </code></pre>
            </section>

            <section>
                <h2>For vs Apply</h2>
                <pre><code data-trim data-noescape class="language-r">
                    library(ggplot2)
                    library(microbenchmark)
                    mb &lt;- microbenchmark(f_for(1e5), f_apply(1e5))
                    autoplot(mb)
                </code></pre>
            </section>

            <section>
                <img src="img/for_vs_apply.png" alt="" width="60%">
            </section>

            <section>
                <h2>R System</h2>
                <img src="img/r_system_arch.png" alt="" width="100%">
            </section>

            <section>
                <h2>Compiling</h2>
                <pre><code data-trim data-noescape class="language-r">
                    library(compiler)
                    f_for_cmp &lt;- cmpfun(f_for)
                </code></pre>
            </section>

            <section>
                <img src="img/for_cmp.png" alt="" width="70%">
            </section>

            <section>
                <p>Modern R version actually tries to compile your functions automatically</p>
                <pre><code data-trim data-noescape class="language-r">
                    &gt; f_for
                    function(k) {
                       re &lt;- rep(0, k)
                       for (i in 1:k) {
                          re[i] &lt;- i^1.5
                       }
                       return(re)
                    }
                    &lt;bytecode: 0x7f9cd5aaa240&gt;                    
                </code></pre>
            </section>

            <section>
                <h2>Vectorization</h2>
                <pre><code data-trim data-noescape class="language-r">
                    z &lt;- x + y
                    for (i in 1:10000) z[i] &lt;- x[i] + y[i]
                </code></pre>
                <ul>
                    <li>The first line call function <emphcode>+</emphcode> once, while the second call many functions
                        and
                        some 10000 times</li>
                    <li>The + function actually written in C</li>
                </ul>
            </section>

            <section>
                <h2>Example</h2>
                <pre><code data-trim data-noescape class="language-r">
                    max_norm &lt;- function(nreps) {
                        sum &lt;- 0
                        for (i in 1:nreps) {
                            xy &lt;- rnorm(2)
                            sum &lt;- sum + max(xy)
                        }
                        return(sum/nreps)
                    }
                    system.time(max_norm(1e6))
                    user  system elapsed 
                    1.09    0.00    1.10 
                </code></pre>
                <p>Small mem but slow exec</p>
            </section>



            <section>
                <h2>Example</h2>
                <pre><code data-trim data-noescape class="language-r">
                    max_norm2 &lt;- function(nreps) {
                        xymat &lt;- matrix(rnorm(2*nreps), ncol = 2)
                        maxs &lt;- pmax(xymat[,1], xymat[,2])
                        return(mean(maxs))
                    }
                    system.time(max_norm2(1e6))
                    user  system elapsed 
                    0.08    0.00    0.08 
                </code></pre>
                <p>Large mem for sotring the matrix, but fast exec</p>
            </section>

            <section>
                <h2>Simpler Data Structure</h2>
                <ul>
                    <li>Complex data structures (e.g. class) requires more time </li>
                    <li>Simpler data structure requires less work for type checking, formatting, and etc</li>
                </ul>
            </section>

            <section>
                <h2>Direct Function Calls</h2>
                <ul>
                    <li>S3/S4 systems can add some computation time</li>
                    <li>R offers various functions for the same purpose
                    </li>
                    <li>Some functions are slower (for generic data structures) and some are faster (for specific and
                        simpler data structures)</li>
                </ul>
            </section>

            <section>
                <pre><code data-trim data-noescape class="language-r">
                    m &lt;- matrix(rnorm(1e4 * 100), 1e4, 100)
                    mb &lt;- microbenchmark(apply(m, 1, mean),  rowMeans(m))
                    autoplot(mb)                    
                </code></pre>
            </section>

            <section>
                <img src="img/rowmeans_vs_apply.png" alt="" width="60%">
            </section>


            <section>
                <pre><code data-trim data-noescape class="language-r">
                    m &lt;-  rnorm(1e4) 
                    mb &lt;- microbenchmark(mean(m),  sum(m)/length(m))
                    autoplot(mb)                                   
                </code></pre>
            </section>

            <section>
                <img src="img/sum_vs_mean.png" alt="" width="60%">
            </section>

            <section>
                <h2>Pre-allocation</h2>
                <ul>
                    <li>Most R data structures are copy-on-modify</li>
                    <li>Concatenation crreates multiple copies</li>
                    <li>Pre-allocation usually avoid potential copy-on-modify</li>
                </ul>
            </section>

            <section>
                <h1>Parallel</h1>
            </section>

            <section>
                <h2>Parallel</h2>
                <ul>
                    <li>Modern R includes pkg parallel by default</li>
                    <li>Many other parallel mechanisms possible via other pkgs
                        <ul>
                            <li>snow, Rmpi, multicore, ...</li>
                        </ul>
                    </li>
                    <li>Microsoft R Open has parallel R enabled by default, but may not always improve speed</li>
                </ul>
            </section>

            <section>
                <h2>Types of Parallelism</h2>
                <ul>
                    <li>Shared mem, multiple cores, usually a single machine
                        <ul>
                            <li>Open MP</li>
                        </ul>
                    </li>
                    <li>Multiple machines linked by network
                        <ul>
                            <li>MPI, message passing</li>
                        </ul>
                    </li>
                    <li>Parallel frameworks: Hadoop</li>
                </ul>
            </section>

            <section data-state='para'>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/Shared_memory.svg/1920px-Shared_memory.svg.png"
                    alt="" width="100%">
                <style>
                    .para credit:after {
                        content: "https://en.wikipedia.org/wiki/Shared_memory";
                    }
                </style>
            </section>

            <section>
                <pre><code data-trim data-noescape class="language-r">
                    simu &lt;- function(k) {
                        set.seed(k)
                        X &lt;- matrix(rnorm(1e2*1e4), 1e2, 1e4)
                        b &lt;- rnorm(1e4)
                        return( sum(X%*%b) )
                    }
                    system.time(lapply(1:200, simu))
                    library(parallel)
                    system.time(mclapply(1:200, simu, mc.cores = 3))
                </code></pre>
            </section>

            <section>
                <pre><code data-trim data-noescape class="language-r">
                 &gt; system.time(lapply(1:200, simu))
                    user  system elapsed 
                  12.523   0.229  12.760 
                 &gt; 
                 &gt; library(parallel)
                 &gt; system.time(mclapply(1:200, simu, mc.cores = 3))
                    user  system elapsed 
                   4.181   0.400   4.511 
                </code></pre>
            </section>

            <section>
                <h1>Profiling</h1>
                <ul>
                    <li>To improve speed, you may want to use <emphcode>Rprof</emphcode>
                    </li>
                    <li>Profiling finds the bottle neck or functions that use the most time</li>
                    <li>You may want to focus on optimizing the functions that use the most</li>
                </ul>
            </section>

            <section>
                <h2>Example: Matrix Power</h2>
                <pre><code data-trim data-noescape class="language-r">
                    powers1 &lt;- function(x,dg) {
                        pw &lt;- matrix(x,nrow=length(x))
                        prod &lt;- x  # current product
                        for (i in 2:dg) {
                           prod &lt;- prod * x
                           pw &lt;- cbind(pw,prod)
                        }
                        return(pw)
                    }
                &gt; x &lt;- runif(1e6)
                &gt; Rprof()
                &gt; invisible(powers1(x, 8))
                &gt; Rprof(NULL)
                </code></pre>
            </section>

            <section>
                <h2>Example: Matrix Power</h2>
                <pre><code data-trim data-noescape class="language-r">
                    &gt; summaryRprof()
                    $by.self
                            self.time self.pct total.time total.pct
                    "cbind"         0.26    81.25       0.26     81.25
                    "powers1"       0.04    12.50       0.32    100.00
                    "makeCenv"      0.02     6.25       0.02      6.25

                    $by.total
                                        total.time total.pct self.time self.pct
                    "powers1"                    0.32    100.00      0.04    12.50
                    "cbind"                      0.26     81.25      0.26    81.25
                    "makeCenv"                   0.02      6.25      0.02     6.25
                    ...
                </code></pre>
            </section>

            <section>
                <h2>Rprof</h2>
                <ul>
                    <li>
                        <emphcode>Rprof</emphcode> saves the function calls in effect every 0.02 (default) seconds
                    </li>
                    <li>
                        <emphcode>summaryRprof</emphcode> counts the number of times each function was detected
                    </li>
                    <li>This can be challenging if calling too many functions</li>
                    <li>Alternative packages for visualizing Rprof: <emphcode>profr, proftools</emphcode>
                    </li>
                </ul>
            </section>

            <section>
                <h2>References</h2>
                <ul>
                    <li>AoRP: ch 13, 14, 16</li>
                </ul>
            </section>

        </div>
    </div>

    <script src="reveal.js.4.1.3/dist/reveal.js"></script>
    <script src="reveal.js.4.1.3/plugin/zoom/zoom.js"></script>
    <script src="reveal.js.4.1.3/plugin/notes/notes.js"></script>
    <script src="reveal.js.4.1.3/plugin/search/search.js"></script>
    <script src="reveal.js.4.1.3/plugin/markdown/markdown.js"></script>
    <script src="reveal.js.4.1.3/plugin/highlight/highlight.js"></script>
    <script src="reveal.js.4.1.3/plugin/math/math.js"></script>

    <script>
        // Also available as an ES module, see:
        // https://revealjs.com/initialization/
        Reveal.initialize({
            controls: false,
            progress: true,
            center: true,
            hash: true,
            transition: 'slide', // none/fade/slide/convex/concave/zoom

            width: 1024,
            height: 768,

            slideNumber: 'c/t',

            math: {
                // mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
                config: 'TeX-AMS_HTML-full',
                TeX: {
                    Macros: {
                        R: '\\mathbb{R}',
                        set: ['\\left\\{#1 \\; ; \\; #2\\right\\}', 2]
                    }
                }
            },

            // Learn about plugins: https://revealjs.com/plugins/
            plugins: [RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealMath, RevealHighlight]
        });

    </script>

</body>

</html>